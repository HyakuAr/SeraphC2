# Migration Guide: v1.0.0 to v1.1.0

This guide covers upgrading SeraphC2 from version 1.0.0 to 1.1.0.

## Overview

Version 1.1.0 introduces:
- Enhanced API key management
- Webhook support for external integrations
- Improved audit logging
- Performance optimizations

## Breaking Changes

⚠️ **No breaking changes** in this release. This is a backward-compatible update.

## Prerequisites

- SeraphC2 v1.0.0 currently installed
- Database backup completed
- Node.js 18+ installed
- PostgreSQL 12+ running

## Upgrade Steps

### 1. Backup Current Installation

```bash
# Backup database
pg_dump -h localhost -U postgres -d seraphc2 > backup_v1.0.0_$(date +%Y%m%d_%H%M%S).sql

# Backup configuration files
cp .env .env.backup
cp -r logs logs_backup
```

### 2. Stop Application

```bash
# If running with PM2
pm2 stop seraphc2

# If running with systemd
sudo systemctl stop seraphc2

# If running with Docker
docker-compose down
```

### 3. Update Code

```bash
# Pull latest code
git fetch origin
git checkout v1.1.0

# Or download release
wget https://github.com/YourOrg/SeraphC2/archive/v1.1.0.tar.gz
tar -xzf v1.1.0.tar.gz
```

### 4. Install Dependencies

```bash
# Install new dependencies
npm ci

# Install frontend dependencies
cd web-client && npm ci && cd ..
```

### 5. Run Database Migrations

```bash
# Check migration status
npm run migrate:status

# Apply new migrations
npm run migrate:up
```

Expected migrations for v1.1.0:
- `027_create_api_keys_table.sql` - API key management
- `028_create_webhooks_tables.sql` - Webhook support
- `029_create_export_jobs_table.sql` - Data export functionality
- `030_create_audit_logs_table.sql` - Enhanced audit logging

### 6. Update Configuration

#### New Environment Variables

Add these to your `.env` file:

```bash
# API Key Settings
API_KEY_EXPIRY_DAYS=90
API_KEY_MAX_REQUESTS_PER_HOUR=1000

# Webhook Settings
WEBHOOK_TIMEOUT_MS=30000
WEBHOOK_MAX_RETRIES=3
WEBHOOK_RETRY_DELAY_MS=5000

# Export Settings
EXPORT_MAX_RECORDS=10000
EXPORT_CLEANUP_DAYS=7

# Enhanced Logging
AUDIT_LOG_RETENTION_DAYS=365
AUDIT_LOG_LEVEL=info
```

#### Optional Configuration Updates

```bash
# Performance tuning (optional)
DB_POOL_SIZE=20
REDIS_MAX_CONNECTIONS=50

# Security enhancements (recommended)
SESSION_TIMEOUT_MINUTES=60
PASSWORD_MIN_LENGTH=12
```

### 7. Build Application

```bash
# Build backend
npm run build

# Build frontend
npm run build:web
```

### 8. Start Application

```bash
# Start with PM2
pm2 start dist/index.js --name seraphc2

# Or with systemd
sudo systemctl start seraphc2

# Or with Docker
docker-compose up -d
```

### 9. Verify Upgrade

```bash
# Check application status
curl http://localhost:3000/api/health

# Check version
curl http://localhost:3000/api/version

# Check logs
tail -f logs/combined.log
```

## New Features

### API Key Management

- Create and manage API keys through the web interface
- Set expiration dates and rate limits
- Monitor API key usage

### Webhook Support

- Configure webhooks for external integrations
- Support for multiple webhook endpoints
- Automatic retry on failure

### Enhanced Audit Logging

- Detailed audit trails for all actions
- Configurable retention periods
- Export audit logs to external systems

### Data Export

- Export data in multiple formats (JSON, CSV, XML)
- Scheduled exports
- Automatic cleanup of old export files

## Configuration Changes

### Database Schema

New tables added:
- `api_keys` - API key management
- `webhooks` - Webhook configurations
- `webhook_deliveries` - Webhook delivery logs
- `export_jobs` - Data export job tracking
- `audit_logs` - Enhanced audit logging

### API Changes

New endpoints:
- `GET /api/keys` - List API keys
- `POST /api/keys` - Create API key
- `DELETE /api/keys/:id` - Delete API key
- `GET /api/webhooks` - List webhooks
- `POST /api/webhooks` - Create webhook
- `GET /api/exports` - List export jobs
- `POST /api/exports` - Create export job

## Performance Improvements

- Database query optimization
- Improved caching strategies
- Reduced memory usage
- Faster startup times

## Security Enhancements

- Enhanced API key security
- Improved session management
- Better input validation
- Updated dependencies

## Rollback Procedure

If you need to rollback to v1.0.0:

### 1. Stop Application

```bash
pm2 stop seraphc2
# or
sudo systemctl stop seraphc2
# or
docker-compose down
```

### 2. Rollback Database

```bash
# Rollback migrations
npm run migrate:down 4  # Rollback the 4 new migrations

# Or restore from backup
psql -h localhost -U postgres -d seraphc2 < backup_v1.0.0_20240101_120000.sql
```

### 3. Restore Code

```bash
git checkout v1.0.0
npm ci
npm run build
```

### 4. Restore Configuration

```bash
cp .env.backup .env
```

### 5. Start Application

```bash
pm2 start dist/index.js --name seraphc2
```

## Troubleshooting

### Migration Fails

If database migration fails:

```bash
# Check migration status
npm run migrate:status

# Check database logs
sudo tail -f /var/log/postgresql/postgresql-*.log

# Manual rollback if needed
npm run migrate:down
```

### Application Won't Start

Common issues:
- Check environment variables
- Verify database connectivity
- Check file permissions
- Review application logs

### Performance Issues

If you experience performance issues:
- Monitor database performance
- Check memory usage
- Review log files for errors
- Consider increasing resource limits

## Support

If you encounter issues during the upgrade:

1. Check the [troubleshooting guide](../troubleshooting/common-issues.md)
2. Review the [configuration documentation](../configuration/environment.md)
3. Create an issue on GitHub with:
   - Current version
   - Error messages
   - Configuration details
   - Steps to reproduce

## Next Steps

After successful upgrade:

1. Review new features in the web interface
2. Configure webhooks if needed
3. Set up API keys for integrations
4. Review audit log settings
5. Test all functionality
6. Update monitoring and alerting

## Changelog

For detailed changes, see [CHANGELOG.md](../../CHANGELOG.md#v110).